<!-- –ë–ª–æ–∫ –æ—Ü–µ–Ω–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ -->
<div class="card mb-4 mt-5">
    <div class="card-body">
        <div class="row">
        <div class="col-lg-8">
            <h5 class="mb-3">
                <span class="me-2">üíù</span>
                –ù—Ä–∞–≤–∏—Ç—Å—è –ø—Ä–æ–µ–∫—Ç?
            </h5>
            
            <p class="mb-3 text-muted">
                –•–æ—Ç–∏—Ç–µ —Ä–∞–∑–≤–∏—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–∞? –ù–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–π –±—ã —Ö–æ—Ç–µ–ª–æ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª! 
                –ò –æ—Ü–µ–Ω–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –ª–∞–π–∫–æ–º –∏–ª–∏ –¥–∏–∑–ª–∞–π–∫–æ–º.
            </p>
            
            <!-- –§–æ—Ä–º–∞ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
            <div class="feedback-form mb-4">
                <textarea id="feedback-comment" class="form-control" rows="3" 
                          placeholder="–ù–∞–ø–∏—à–∏—Ç–µ, –∫–∞–∫–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª —Ö–æ—Ç–µ–ª–æ—Å—å –±—ã –≤–∏–¥–µ—Ç—å –≤ –ø—Ä–æ–µ–∫—Ç–µ..."
                          >{% if user_rating.comment %}{{ user_rating.comment }}{% endif %}</textarea>
                
                <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ —Ç–µ–∫—Å—Ç–∞) -->
                <div class="mt-3">
                    <button id="send-feedback-btn" class="btn btn-primary d-none" 
                            hx-post="{% url 'send_feedback' %}" 
                            hx-target="#feedback-status-container" 
                            hx-swap="innerHTML"
                            hx-include="#feedback-comment">
                        <i class="fas fa-paper-plane me-2"></i>–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ–∂–µ–ª–∞–Ω–∏—è
                    </button>
                    
                    {% if user_rating.email_sent %}
                    <div class="text-success mt-2">
                        <small>
                            <i class="fas fa-check-circle me-1"></i>
                            –í–∞—à–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É 
                            ({{ user_rating.email_sent_at|date:"d.m.Y H:i" }})
                        </small>
                    </div>
                    {% endif %}
                </div>
                
                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                <div id="feedback-status-container"></div>
            </div>
            
            <!-- –§–æ—Ä–º–∞ –æ—Ü–µ–Ω–∫–∏ -->
            <form id="project-rating-form" hx-post="{% url 'project_rating' %}" 
                  hx-target="#rating-stats-container" hx-swap="innerHTML">
                {% csrf_token %}
                
                <!-- –°–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å textarea –≤—ã—à–µ) -->
                <input type="hidden" name="comment" id="hidden-comment" value="{% if user_rating.comment %}{{ user_rating.comment }}{% endif %}">
                
                <!-- –ö–Ω–æ–ø–∫–∏ –ª–∞–π–∫/–¥–∏–∑–ª–∞–π–∫ -->
                <div class="rating-buttons mb-3">
                    <button type="submit" name="rating" value="like" 
                            class="btn btn-outline-success me-2 {% if user_rating.rating == 'like' %}active{% endif %}">
                        <span class="me-1">üëç</span> –ù—Ä–∞–≤–∏—Ç—Å—è
                    </button>
                    
                    <button type="submit" name="rating" value="dislike" 
                            class="btn btn-outline-danger {% if user_rating.rating == 'dislike' %}active{% endif %}">
                        <span class="me-1">üëé</span> –ù–µ –Ω—Ä–∞–≤–∏—Ç—Å—è
                    </button>
                </div>
                

            </form>
        </div>
        
        <div class="col-lg-4">
            <h6 class="mb-3">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ü–µ–Ω–æ–∫:</h6>
            <div id="rating-stats-container">
                {% include 'time_tracking_main/partials/project_rating_stats.html' with stats=rating_stats %}
            </div>
        </div>
        </div>
    </div>
</div>

<style>

.rating-buttons .btn {
    min-width: 120px;
    transition: all 0.3s ease;
}

.rating-buttons .btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

.rating-buttons .btn.active {
    box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
}



#send-feedback-btn {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border: none;
    box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
    transition: all 0.3s ease;
}

#send-feedback-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
}

#send-feedback-btn:active {
    transform: translateY(0);
}

.feedback-form textarea {
    border: 2px solid #e9ecef;
    border-radius: 8px;
    transition: border-color 0.3s ease;
}

.feedback-form textarea:focus {
    border-color: #007bff;
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
}

@media (max-width: 768px) {
    .project-rating-block {
        margin-top: 2rem;
        padding: 1.5rem;
    }
    
    .rating-buttons .btn {
        min-width: 100px;
        font-size: 0.9rem;
    }
    
    #send-feedback-btn {
        font-size: 0.9rem;
        padding: 0.5rem 1rem;
    }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const textarea = document.getElementById('feedback-comment');
    const sendBtn = document.getElementById('send-feedback-btn');
    const hiddenComment = document.getElementById('hidden-comment');
    
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –∫–Ω–æ–ø–∫–∏
    function toggleSendButton() {
        const hasText = textarea.value.trim().length > 0;
        
        if (hasText) {
            sendBtn.classList.remove('d-none');
        } else {
            sendBtn.classList.add('d-none');
        }
        
        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ
        if (hiddenComment) {
            hiddenComment.value = textarea.value;
        }
    }
    
    // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ textarea
    if (textarea) {
        textarea.addEventListener('input', toggleSendButton);
        textarea.addEventListener('keyup', toggleSendButton);
        textarea.addEventListener('paste', function() {
            setTimeout(toggleSendButton, 10); // –ó–∞–¥–µ—Ä–∂–∫–∞ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ paste
        });
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        toggleSendButton();
    }
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π —Ñ–æ—Ä–º—ã —Ä–µ–π—Ç–∏–Ω–≥–∞
    const ratingForm = document.getElementById('project-rating-form');
    if (ratingForm) {
        ratingForm.addEventListener('htmx:configRequest', function() {
            if (hiddenComment && textarea) {
                hiddenComment.value = textarea.value;
            }
        });
    }
});

// –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ HTMX –∑–∞–ø—Ä–æ—Å–∞
document.addEventListener('htmx:afterRequest', function(event) {
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞
    if (event.detail.target.id === 'rating-stats-container') {
        const form = document.getElementById('project-rating-form');
        const buttons = form.querySelectorAll('.rating-buttons .btn');
        
        // –°–Ω–∏–º–∞–µ–º –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Å–æ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
        buttons.forEach(btn => btn.classList.remove('active'));
        
        // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç—É—é –∫–Ω–æ–ø–∫—É
        if (event.detail.xhr.status === 200) {
            const submitter = event.detail.requestConfig.elt;
            if (submitter && submitter.name === 'rating') {
                submitter.classList.add('active');
            }
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ feedback
    if (event.detail.target.id === 'feedback-status-container') {
        if (event.detail.xhr.status === 200) {
            // –°–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏
            const sendBtn = document.getElementById('send-feedback-btn');
            if (sendBtn) {
                sendBtn.classList.add('d-none');
            }
            
            // –ê–≤—Ç–æ—Å–∫—Ä—ã—Ç–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(function() {
                const alerts = document.querySelectorAll('#feedback-status-container .alert');
                alerts.forEach(alert => {
                    if (alert) {
                        alert.classList.add('fade');
                        setTimeout(() => alert.remove(), 300);
                    }
                });
            }, 5000);
        }
    }
});

// –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª–µ comment –≤ HTMX –∑–∞–ø—Ä–æ—Å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ feedback
document.addEventListener('htmx:configRequest', function(event) {
    if (event.detail.path === '{% url "send_feedback" %}') {
        const textarea = document.getElementById('feedback-comment');
        if (textarea) {
            event.detail.parameters['comment'] = textarea.value;
        }
    }
});
</script>