{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}


{% block content %}
    <br>
    <br>
    {% include 'includes/inegrations.html' %}

    <p id="current-time" style="font-size:2rem; text-align:center;">–ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–µ–º–µ–Ω–∏...</p>
    <script src="{% static 'js/realtime.js' %}"></script>

    <form method="post" action="{% url 'start_interval' %}"
          hx-post="{% url 'start_interval' %}"
          hx-target="body"
          hx-swap="outerHTML">
        {% csrf_token %}
        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-secondary full-width">–°—Ç–∞—Ä—Ç</button>
        </div>
        <br>
    </form>

    <form method="post" action="{% url 'stop_interval' %}"
          hx-post="{% url 'stop_interval' %}"
          hx-target="body"
          hx-swap="outerHTML">
        {% csrf_token %}
        <div class="d-grid gap-2">
            <button type="submit" class="btn btn-secondary full-width">–°—Ç–æ–ø</button>
        </div>
    </form>
    {#HTMX-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–°—Ç–∞—Ä—Ç" –∏ "–°—Ç–æ–ø" ‚Äî —Ç–µ–ø–µ—Ä—å –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ —ç—Ç–∏ –¥–µ–π—Å—Ç–≤–∏—è –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ, –±–µ–∑ –ø–æ–ª–Ω–æ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã. –†–µ–∑—É–ª—å—Ç–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞) –±—É–¥–µ—Ç –ø–æ–¥–≥—Ä—É–∂–∞—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏#}
    <form method="POST" action="{% url 'add_manual_interval' %}"
          hx-post="{% url 'add_manual_interval' %}"
          hx-target="body"
          hx-swap="outerHTML">
        {% csrf_token %}
        <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä—É—á–Ω—É—é</h2>
        <label for="start_time">–ù–∞—á–∞–ª–æ:</label>
        <input type="time" id="start_time" name="start_time" required>
        <label for="end_time">–ö–æ–Ω–µ—Ü:</label>
        <input type="time" id="end_time" name="end_time" required>
        <div class="d-grid gap-2">
            <button class="btn btn-success" type="submit" name="add_manual_interval">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä—É—á–Ω—É—é</button>
        </div>
    </form>

    {#    <form method="POST" action="{% url 'add_manual_interval' %}">#}
    {#        {% csrf_token %}#}
    {#        <h2>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä—É—á–Ω—É—é</h2>#}
    {#    </form>#}


    {#    <div>#}
    {#    <label for="start_time">–ù–∞—á–∞–ª–æ:</label>#}
    {#    <input type="time" id="start_time" name="start_time" required>#}
    {#    <label for="end_time">–ö–æ–Ω–µ—Ü:</label>#}
    {#    <input type="time" id="end_time" name="end_time" required>#}
    {#    <div>#}
    {#        <div class="d-grid gap-2">#}
    {#            <button class="btn btn-success" type="submit" name="add_manual_interval">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª –≤—Ä—É—á–Ω—É—é#}
    {#            </button>#}
    {#        </div>#}
    {#    </div>#}



    <h2>–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è {{ selected_date }}</h2>

    <form method="get" action="{% url 'home' %}">
        <label>
            <input type="date" name="date" value="{{ selected_date|date:'Y-m-d' }}">
        </label>
        <button type="submit">–í—ã–±—Ä–∞—Ç—å –¥–∞—Ç—É</button>
    </form>

    {##}

    {#    <tbody>#}
    {#    {% for interval in page_obj %}#}
    {#        <tr>#}
    {#            <td>#}
    {#                <a href="{% url 'interval_detail' interval.id %}">#}
    {#                    {{ interval.start_time }}#}
    {#                </a>#}
    {#            </td>#}
    {#            <td>#}
    {#                <a href="{% url 'interval_detail' interval.id %}">#}
    {#                    {% if interval.end_time %}#}
    {#                        {{ interval.end_time }}#}
    {#                    {% else %}#}
    {#                        –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞#}
    {#                    {% endif %}#}
    {#                </a>#}
    {#            </td>#}
    {#            <td>#}
    {#                <a href="{% url 'interval_detail' interval.id %}">#}
    {#                    {{ interval.duration | duration_format }}#}
    {#                </a>#}
    {#            </td>#}
    {#        </tr>#}
    {#    {% empty %}#}
    {#        <tr>#}
    {#            <td colspan="3">–ù–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã.</td>#}
    {#        </tr>#}
    {#    {% endfor %}#}
    {#</tbody>#}

    {#        <div>#}
    {#            {% for interval in intervals %}#}
    {#                <tr id="interval-{{ interval.id }}">#}
    {#                    <td id="interval-{{ interval.id }}-start">#}
    {#                        <button class="btn btn-secondary btn-sm"#}
    {#                                hx-get="{% url 'edit_interval_field' interval.id 'start_time' %}"#}
    {#                                hx-target="#interval-{{ interval.id }}-start"#}
    {#                                hx-swap="outerHTML">#}
    {#                            ‚úèÔ∏è –°—Ç–∞—Ä—Ç#}
    {#                        </button>#}
    {#                        {{ interval.start_time }}#}
    {#                    </td>#}
    {#                    <td id="interval-{{ interval.id }}-end">#}
    {#                        <button class="btn btn-secondary btn-sm"#}
    {#                                hx-get="{% url 'edit_interval_field' interval.id 'end_time' %}"#}
    {#                                hx-target="#interval-{{ interval.id }}-end"#}
    {#                                hx-swap="outerHTML">#}
    {#                            ‚úèÔ∏è –°—Ç–æ–ø#}
    {#                        </button>#}
    {#                        {{ interval.end_time }}#}
    {#                    </td>#}
    {#                    <!-- –¥—Ä—É–≥–∏–µ —Å—Ç–æ–ª–±—Ü—ã -->#}
    {#                </tr>#}
    {#            {% endfor %}#}
    {#        </div>#}

    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered text-center">
            <thead class="table-dark text-center">
            <tr>
                <th scope="col">–°—Ç–∞—Ä—Ç</th>
                <th scope="col">–°—Ç–æ–ø</th>
                <th scope="col">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</th>
                <th scope="col">–î–µ–π—Å—Ç–≤–∏–µ</th>


            </tr>
            </thead>
            <tbody>
            {% for interval in page_obj %}
                <tr>
                    <td>
                        <a href="{% url 'interval_detail' interval.id %}">
                            {{ interval.start_time }}</a>

                    </td>
                    <td>
                        {% if interval.end_time %}
                            {{ interval.end_time }}
                        {% else %}
                            –ò–¥–µ—Ç –∑–∞–ø–∏—Å—å –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞
                        {% endif %}
                    </td>
                    <td>{{ interval.duration | duration_format }}</td>
                    <!--  –Ø—á–µ–π–∫–∞ –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è -->
                    <td>
                        {#–†–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å                        #}
                        <button class="disbtn"
                                hx-get="{% url 'update_interval' interval.id %}"
                                hx-target="closest tr"
                                hx-swap="outerHTML">
                            <span style="font-size: 1.2em;">‚úèÔ∏è</span>

                        </button>

                        <!-- –ö–Ω–æ–ø–∫–∞ "Delete" -->
                        <button class="disbtn"

                                hx-delete="{% url 'interval_delite_htmx' interval.id %}"
                                hx-target="closest tr"
                                hx-swap="outerHTML"
                                hx-confirm="–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª?">
                            <span style="font-size: 1.2em;">üóëÔ∏è</span>

                        </button>
                    </td>

                </tr>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="3">–ù–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ –¥–ª—è —ç—Ç–æ–π –¥–∞—Ç—ã.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
        {% include 'includes/pagination.html' %}
    </div>
    {#        <h2>–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è {{ selected_date }} (–ò—Ç–æ–≥–∏ –¥–Ω—è: {{ daily_summaries|get_summary:selected_date }})</h2>#}
    {#    <h2>–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è {{ selected_date }} </h2>#}
    {#    <h2>{{ daily_summaries|get_summary:selected_date|safe }})</h2>#}
    {#    <h2>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤ {{ daily_summaries|get_summary_interval_count:selected_date }}</h2>#}
    {#    <h2>–û–±—â–µ–µ –≤—Ä–µ–º—è –∑–∞ –¥–µ–Ω—å</h2><h1>{{ daily_summaries|get_summary_total_time:selected_date }}</h1>#}

    <h2>–ò—Ç–æ–≥–∏ –¥–Ω—è</h2>
    <div class="table-responsive">
        <table class="table table-striped table-hover table-bordered text-center">
            <thead class="table-dark text-center">
            <tr>
                <th scope="col">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤</th>
                <th scope="col">–ò—Ç–æ–≥–æ–≤–æ–µ –≤—Ä–µ–º—è</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>{{ daily_summaries|get_summary_interval_count:selected_date }}</td>
                <td>{{ daily_summaries|get_summary_total_time:selected_date }}</td>

            </tr>
            </tbody>
        </table>

    </div>
    {#    </body>#}
    {##}
    {#    </div>#}
    {#<h2>–ò—Ç–æ–≥–∏ –¥–Ω—è</h2>#}
    {#{% include 'time_tracking_main/daily_summary.html' %}#}
    {#</body>#}
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞—Ç—Ä–∏–±—É—Ç–∞ —É –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –∑–∞–¥–∞–Ω–Ω—ã–º –∫–ª–∞—Å—Å–æ–º
        function cngElementsAtr(cls, atr, val) {
            var elems = document.getElementsByClassName(cls); // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å –∫–ª–∞—Å—Å–æ–º cls
            for (var i = 0; i < elems.length; i++) {
                elems[i][atr] = val; // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞—Ç—Ä–∏–±—É—Ç atr –≤ –∑–Ω–∞—á–µ–Ω–∏–µ val
            }
        }

        // –°–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏–µ htmx:afterRequest (–ø–æ—Å–ª–µ –ª—é–±–æ–≥–æ HTMX-–∑–∞–ø—Ä–æ—Å–∞)
        document.body.addEventListener('htmx:afterRequest', (event) => {
            let path_str = event.detail.pathInfo.requestPath; // –ü–æ–ª—É—á–∞–µ–º –ø—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞
            if (path_str.includes('create_interval')) { // –ï—Å–ª–∏ –ø—É—Ç—å —Å–æ–¥–µ—Ä–∂–∏—Ç create_interval
                cngElementsAtr('clrtxt', 'value', ''); // –û—á–∏—â–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è —É —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å –∫–ª–∞—Å—Å–æ–º clrtxt
            } else if (path_str.includes('update_interval')) { // –ï—Å–ª–∏ –ø—É—Ç—å —Å–æ–¥–µ—Ä–∂–∏—Ç update_interval
                if (event.detail.requestConfig.verb === 'get') { // –ï—Å–ª–∏ —ç—Ç–æ GET-–∑–∞–ø—Ä–æ—Å (–æ—Ç–∫—Ä—ã—Ç–∏–µ —Ñ–æ—Ä–º—ã)
                    cngElementsAtr('disbtn', 'disabled', true); // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å –∫–ª–∞—Å—Å–æ–º disbtn –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏
                } else { // –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ GET-–∑–∞–ø—Ä–æ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä, POST –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)
                    cngElementsAtr('disbtn', 'disabled', false); // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ –æ–±—Ä–∞—Ç–Ω–æ
                }
            } else if (path_str.includes('interval_detail_new')) { // –ï—Å–ª–∏ –ø—É—Ç—å —Å–æ–¥–µ—Ä–∂–∏—Ç interval_detail_new
                cngElementsAtr('disbtn', 'disabled', false); // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫–∏ —Å –∫–ª–∞—Å—Å–æ–º disbtn
            }
        });
    </script>
{% endblock %}


