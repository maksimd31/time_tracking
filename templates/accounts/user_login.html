{% extends 'base.html' %}

{% block content %}
    <script src="https://yastatic.net/s3/passport-sdk/autofill/v1/sdk-suggest-with-polyfills-latest.js"></script>

    <div class="row justify-content-center">
        <div class="col-xl-5 col-lg-6">
            <div class="card mb-4">
                <div class="card-body p-5">
                    <h2 class="h4 fw-semibold mb-3">Вход в аккаунт</h2>
                    <p class="text-muted-soft mb-4">Продолжайте отслеживать свои проекты. Заполните форму или авторизуйтесь через соцсети.</p>
                    <form method="post" action="{% url 'login' %}" class="vstack gap-3">
                        {% csrf_token %}
                        {{ form.non_field_errors }}
                        <div>
                            {{ form.username.label_tag }}
                            {{ form.username }}
                            {% if form.username.errors %}<div class="text-danger small">{{ form.username.errors|join:', ' }}</div>{% endif %}
                        </div>
                        <div>
                            {{ form.password.label_tag }}
                            {{ form.password }}
                            {% if form.password.errors %}<div class="text-danger small">{{ form.password.errors|join:', ' }}</div>{% endif %}
                        </div>
                        {% if form.remember_me %}
                        <div class="form-check">
                            {{ form.remember_me }}
                            <label class="form-check-label" for="{{ form.remember_me.id_for_label }}">Запомнить меня</label>
                        </div>
                        {% endif %}
                        <button type="submit" class="btn btn-primary">Войти</button>
                    </form>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <a class="text-muted-soft" href="{% url 'password_reset' %}">Забыли пароль?</a>
                        <a class="text-muted-soft" href="{% url 'register' %}">Создать аккаунт</a>
                    </div>
                </div>
            </div>
            <div class="card border-0">
                <div class="card-body p-4 text-center">
                    <a href="{% url 'social:begin' 'vk-oauth2' %}" class="btn btn-outline-secondary w-100 mb-3">Войти через VK (classic OAuth)</a>
                    <div class="mx-2">
                        {% include 'includes/inegrations.html' %}
                    </div>
                </div>
            </div>
        </div>
    </div>

<div>
  <script src="https://unpkg.com/@vkid/sdk@<3.0.0/dist-sdk/umd/index.js"></script>
  <script type="text/javascript">
    (function(){
      const appId = '{{ vkid_app_id|default:"" }}';
      const redirectUrl = '{{ vkid_redirect_url|default:"" }}';
      const scope = '{{ vkid_scope|default:"" }}';
      const frontendMode = {{ vkid_frontend_exchange|yesno:"true,false" }};
      if (!appId || !redirectUrl) { return; }
      if (!('VKIDSDK' in window)) { return; }
      const VKID = window.VKIDSDK;

      VKID.Config.init({
        app: parseInt(appId, 10),
        redirectUrl: redirectUrl,
        responseMode: VKID.ConfigResponseMode.Callback,
        source: VKID.ConfigSource.LOWCODE,
        scope: scope
      });

      const oAuth = new VKID.OAuthList();
      oAuth.render({
        container: document.currentScript.parentElement,
        oauthList: ['vkid','ok_ru','mail_ru']
      })
      .on(VKID.WidgetEvents.ERROR, function(error){
        console.error('VKID error', error);
        alert('Ошибка VK ID: ' + (error && error.message ? error.message : error));
      })
      .on(VKID.OAuthListInternalEvents.LOGIN_SUCCESS, function(payload){
        const code = payload.code;
        const deviceId = payload.device_id;
        const codeVerifier = payload.code_verifier;

        if (frontendMode) {
          // Режим фронтенд-обмена: получаем access_token на клиенте, потом отправляем на сервер
          VKID.Auth.exchangeCode(code, deviceId)
            .then(function(data){
              if (!data || !data.access_token) {
                alert('Не удалось получить access_token');
                return;
              }
              fetch('{% url 'vkid_callback' %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ access_token: data.access_token })
              })
              .then(r=>r.json())
              .then(function(resp){
                if (resp.success) {
                  window.location.href = '/';
                } else {
                  alert('Ошибка сервера VKID: ' + JSON.stringify(resp.message || resp));
                }
              })
              .catch(err => alert('Сетевая ошибка (frontend exchange): ' + err));
            })
            .catch(function(err){
              console.error('VKID exchangeCode error', err);
              alert('Ошибка получения токена: ' + (err && err.message ? err.message : err));
            });
        } else {
          // Backend exchange: отправляем code/device_id(/code_verifier) на сервер
          fetch('{% url 'vkid_callback' %}', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code, device_id: deviceId, code_verifier: codeVerifier })
          })
          .then(r => r.json())
          .then(data => {
            if (data.success) {
              window.location.href = '/';
            } else {
              alert('Ошибка: ' + (data.message || 'Авторизация не удалась'));
            }
          })
          .catch(err => alert('Сетевая ошибка VKID: ' + err));
        }
      });
    })();
  </script>
</div>
{% endblock %}
