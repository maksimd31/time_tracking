{% load static account_tags %}

<!-- Подключение CSS стилей для навигации -->
<link rel="stylesheet" href="{% static 'css/navbar.css' %}">
{% if request.session.is_guest %}
<link rel="stylesheet" href="{% static 'css/guest-tooltip.css' %}">
{% endif %}

<nav class="navbar navbar-expand-lg navbar-modern sticky-top">
    <div class="container d-flex align-items-center position-relative">
        <a class="navbar-brand" href="{% url 'home' %}">
            <span class="mark">⏱</span><span class="brand-text ms-1">Подсчет времени</span>
        </a>
        {% if request.session.is_guest %}
        <!-- Постоянно видимый гостевой бейдж -->
    <div class="guest-badge guest-badge-fixed">
            <span class="badge bg-warning text-dark px-3 py-2">Гостевой режим</span>
            <div class="guest-tooltip">
                <h6 class="fw-semibold mb-2">Гостевой режим</h6>
                <p class="mb-2">Мы сохранили ваши счетчики по IP. Данные доступны пока вы используете это устройство и сеть.</p>
                <ul class="list-unstyled mb-2">
                    <li>• Один браузер, без синхронизации</li>
                    <li>• Аналитика скрыта</li>
                    <li>• Доступ ограничен текущим IP</li>
                </ul>
                <div class="guest-tooltip__footer">
                    <span class="text-muted">Создайте аккаунт и получите:</span>
                    <ul class="list-unstyled mb-0">
                        <li>• Сохранение счетчиков в облаке</li>
                        <li>• Аналитику и статистику</li>
                        <li>• Доступ с любого устройства</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Кнопка компактного меню (три точки) для маленьких ширин -->
        <div class="dropdown compact-ellipsis-wrapper">
            <button class="btn nav-ellipsis-btn" id="compactExtraBtn" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Дополнительное меню">
                <span class="dots">•••</span>
            </button>
            <ul class="dropdown-menu shadow dropdown-menu-start" id="compactExtraMenu" aria-label="Компактное меню"></ul>
        </div>
        <button class="navbar-toggler text-white d-none" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar"
                aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse flex-grow-1" id="mainNavbar">
            <div class="nav-functional d-flex flex-grow-1">
            <ul class="navbar-nav align-items-lg-center flex-grow-1" id="primaryNavItems">
                {% if user.is_authenticated %}
                    {% user_profile request.user as nav_profile %}
                    {% comment %} <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" data-short-text data-short-limit="5" data-short-at="1000" href="{% url 'home' %}">Счетчики</a>
                    </li> {% endcomment %}
                    <li class="nav-item" data-functional-item data-functional-priority="20">
                        <a class="nav-link {% if request.resolver_match.url_name == 'counter_summary' %}active{% endif %}" href="{% url 'counter_summary' %}">Аналитика</a>
                    </li>
                {% else %}
                    <li class="nav-item me-lg-2">
                        <a class="nav-link" href="{% url 'login' %}">Войти</a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-primary" data-hide-below="600" href="{% url 'register' %}">Создать аккаунт</a>
                    </li>
                {% endif %}
            </ul>
            </div>
        </div>
        {% if user.is_authenticated %}
            {% user_profile request.user as nav_profile %}
            <div class="nav-profile dropdown ms-auto ps-3">
                <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" id="userDropdownOutside" role="button" data-bs-toggle="dropdown" aria-label="Профиль пользователя" aria-expanded="false">
                    <span class="avatar-thumb">
                        {% if nav_profile.avatar_url %}
                            <img src="{{ nav_profile.avatar_url }}" alt="{{ request.user.username }}" />
                        {% else %}
                            <span class="avatar-initial">{{ nav_profile.initial }}</span>
                        {% endif %}
                    </span>
                    <span class="user-name">{{ request.user.get_full_name|default:request.user.username }}</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end shadow profile-dropdown-adaptive" aria-labelledby="userDropdownOutside">
                    {% if nav_profile.profile and not request.session.is_guest %}
                        <li><a class="dropdown-item" href="{% url 'profile_detail' nav_profile.profile.slug %}">Профиль и настройки</a></li>
                    {% endif %}
                    {% if request.session.is_guest %}
                        <li><a class="dropdown-item" href="{% url 'register' %}">Создать аккаунт</a></li>
                        <li><a class="dropdown-item" href="{% url 'login' %}">Войти</a></li>
                        <li><span class="dropdown-item-text text-muted">Гостевой режим</span></li>
                        <li><hr class="dropdown-divider"></li>
                    {% endif %}
                    {% if not request.session.is_guest %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form action="{% url 'logout' %}" method="post" class="px-3">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-link p-0 text-decoration-none">Выйти</button>
                            </form>
                        </li>
                    {% endif %}
                </ul>
            </div>
        {% endif %}
    </div>
</nav>
