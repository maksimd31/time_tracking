{% load static account_tags %}
<nav class="navbar navbar-expand-lg navbar-modern sticky-top">
    <div class="container d-flex align-items-center position-relative">
        <a class="navbar-brand" href="{% url 'home' %}">
            <span class="mark">⏱</span><span class="brand-text ms-1">Подсчет времени</span>
        </a>
        {% if request.session.is_guest %}
        <!-- Постоянно видимый гостевой бейдж -->
    <div class="guest-badge guest-badge-fixed">
            <span class="badge bg-warning text-dark px-3 py-2">Гостевой режим</span>
            <div class="guest-tooltip">
                <h6 class="fw-semibold mb-2">Гостевой режим</h6>
                <p class="mb-2">Мы сохранили ваши счетчики по IP. Данные доступны пока вы используете это устройство и сеть.</p>
                <ul class="list-unstyled mb-2">
                    <li>• Один браузер, без синхронизации</li>
                    <li>• Аналитика скрыта</li>
                    <li>• Доступ ограничен текущим IP</li>
                </ul>
                <div class="guest-tooltip__footer">
                    <span class="text-muted">Создайте аккаунт и получите:</span>
                    <ul class="list-unstyled mb-0">
                        <li>• Сохранение счетчиков в облаке</li>
                        <li>• Аналитику и статистику</li>
                        <li>• Доступ с любого устройства</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Кнопка компактного меню (три точки) для маленьких ширин -->
        <div class="dropdown compact-ellipsis-wrapper">
            <button class="btn nav-ellipsis-btn" id="compactExtraBtn" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Дополнительное меню">
                <span class="dots">•••</span>
            </button>
            <ul class="dropdown-menu shadow dropdown-menu-start" id="compactExtraMenu" aria-label="Компактное меню"></ul>
        </div>
        <button class="navbar-toggler text-white" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar"
                aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse flex-grow-1" id="mainNavbar">
            <div class="nav-functional d-flex flex-grow-1">
            <ul class="navbar-nav align-items-lg-center flex-grow-1" id="primaryNavItems">
                {% if user.is_authenticated %}
                    {% user_profile request.user as nav_profile %}
                    {% comment %} <li class="nav-item">
                        <a class="nav-link {% if request.resolver_match.url_name == 'home' %}active{% endif %}" data-short-text data-short-limit="5" data-short-at="1000" href="{% url 'home' %}">Счетчики</a>
                    </li> {% endcomment %}
                    <li class="nav-item" data-functional-item data-functional-priority="20">
                        <a class="nav-link {% if request.resolver_match.url_name == 'counter_summary' %}active{% endif %}" data-short-text data-short-limit="6" data-short-at="1080" href="{% url 'counter_summary' %}">Аналитика</a>
                    </li>
                {% else %}
                    <li class="nav-item me-lg-2">
                        <a class="nav-link" href="{% url 'login' %}">Войти</a>
                    </li>
                    <li class="nav-item">
                        <a class="btn btn-primary" data-hide-below="600" href="{% url 'register' %}">Создать аккаунт</a>
                    </li>
                {% endif %}
            </ul>
            </div>
        </div>
        {% if user.is_authenticated %}
            {% user_profile request.user as nav_profile %}
            <div class="nav-profile dropdown ms-auto ps-3">
                <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" href="#" id="userDropdownOutside" role="button" data-bs-toggle="dropdown" aria-label="Профиль пользователя" aria-expanded="false">
                    <span class="avatar-thumb">
                        {% if nav_profile.avatar_url %}
                            <img src="{{ nav_profile.avatar_url }}" alt="{{ request.user.username }}" />
                        {% else %}
                            <span class="avatar-initial">{{ nav_profile.initial }}</span>
                        {% endif %}
                    </span>
                    <span class="user-name">{{ request.user.get_full_name|default:request.user.username }}</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end shadow profile-dropdown-adaptive" aria-labelledby="userDropdownOutside">
                    {% if nav_profile.profile and not request.session.is_guest %}
                        <li><a class="dropdown-item" href="{% url 'profile_detail' nav_profile.profile.slug %}">Профиль и настройки</a></li>
                    {% endif %}
                    {% if request.session.is_guest %}
                        <li><a class="dropdown-item" href="{% url 'register' %}">Создать аккаунт</a></li>
                        <li><a class="dropdown-item" href="{% url 'login' %}">Войти</a></li>
                        <li><span class="dropdown-item-text text-muted">Гостевой режим</span></li>
                        <li><hr class="dropdown-divider"></li>
                    {% endif %}
                    {% if not request.session.is_guest %}
                        <li><hr class="dropdown-divider"></li>
                        <li>
                            <form action="{% url 'logout' %}" method="post" class="px-3">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-link p-0 text-decoration-none">Выйти</button>
                            </form>
                        </li>
                    {% endif %}
                </ul>
            </div>
        {% endif %}
    </div>
</nav>

<style>
/* Компактные стили для предотвращения переполнения */
@media (max-width: 1200px) and (min-width: 992px) {
    .navbar-modern .nav-link { padding: 6px 10px !important; font-size: 0.9rem; }
    .navbar-modern .navbar-brand { font-size: 0.95rem; }
    .guest-badge .badge { padding: 0.4rem 0.7rem !important; font-size: 0.7rem; }
}
@media (max-width: 700px) {
    /* Скрываем текст бренда, оставляя только иконку */
    .navbar-modern .navbar-brand { gap: 4px; }
    .navbar-modern .navbar-brand .brand-text { display: none !important; }
}
/* Разрешаем перенос пунктов (чтобы не "исчезали") */
@media (min-width: 992px) {
    #primaryNavItems { flex-wrap: wrap; }
    #primaryNavItems > li { margin-top: 2px; margin-bottom: 2px; }
}
/* Сокрытие ника при сужении ширины (для внешнего блока профиля) */
@media (max-width: 1100px) and (min-width: 992px) {
    .nav-profile .user-name { display: none !important; }
}
@media (max-width: 700px) {
        .nav-profile .user-name { display: none !important; }
}
/* Гостевой бейдж ближе к профилю */
/* Гостевой бейдж - по центру страницы */
.guest-badge-fixed {
  position: fixed !important;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 1030;
  pointer-events: auto;
  transition: all 0.3s ease;
}
/* Три точки (компактное меню) – показываем только когда есть переполнение */
.compact-ellipsis-wrapper { display: none; }
.compact-ellipsis-wrapper.ellipsis-visible { display: block; margin-left: 6px; }
.nav-ellipsis-btn { background: rgba(255,255,255,0.08); color: #fff; border: 1px solid rgba(255,255,255,0.2); padding: 4px 10px; display:flex; align-items:center; justify-content:center; border-radius:12px; font-weight:600; font-size:0.95rem; }
.nav-ellipsis-btn:hover { background: rgba(255,255,255,0.18); }
.nav-ellipsis-btn .dots { letter-spacing:2px; }
#compactExtraMenu { min-width: 180px; }
/* Область функциональных пунктов */
.nav-functional { position: relative; min-width:0; }
.nav-functional #primaryNavItems { flex-wrap: nowrap; }
.nav-functional #primaryNavItems > li { white-space: nowrap; }
.compact-ellipsis-wrapper { margin-left: 8px; }

/* === ПОЛНАЯ ОПТИМИЗАЦИЯ ДЛЯ ВСЕХ УСТРОЙСТВ === */
/* Экстра большие экраны (1400px+) - максимальная функциональность */
@media (min-width: 1400px) {
  .navbar-modern .nav-link { padding: 8px 16px !important; font-size: 1rem; }
  .navbar-modern .navbar-brand { font-size: 1.1rem; }
  .guest-badge-fixed .badge { padding: 0.5rem 1rem !important; font-size: 0.875rem; }
  .nav-profile .user-name { display: inline !important; }
}

/* Большие экраны (1200-1399px) - полная функциональность */
@media (min-width: 1200px) and (max-width: 1399px) {
  .navbar-modern .nav-link { padding: 7px 14px !important; font-size: 0.95rem; }
  .navbar-modern .navbar-brand { font-size: 1.05rem; }
  .guest-badge-fixed .badge { padding: 0.45rem 0.9rem !important; font-size: 0.8rem; }
}

/* Средние экраны (992-1199px) - компактная функциональность */
@media (min-width: 992px) and (max-width: 1199px) {
  .navbar-modern .nav-link { padding: 6px 12px !important; font-size: 0.9rem; }
  .navbar-modern .navbar-brand { font-size: 1rem; }
  .guest-badge-fixed .badge { padding: 0.4rem 0.8rem !important; font-size: 0.75rem; }
  .nav-profile .user-name { font-size: 0.85rem; }
}

/* Планшеты (768-991px) - адаптивное сжатие */
@media (min-width: 768px) and (max-width: 991px) {
  .navbar-modern .nav-link { padding: 5px 10px !important; font-size: 0.85rem; }
  .navbar-modern .navbar-brand { font-size: 0.95rem; }
  .guest-badge-fixed .badge { padding: 0.35rem 0.7rem !important; font-size: 0.7rem; }
  .nav-profile .user-name { display: none !important; }
  .navbar-modern .brand-text { font-size: 0.9rem; }
}

/* Мобильные большие (576-767px) - максимальная компактность */
@media (min-width: 576px) and (max-width: 767px) {
  .navbar-modern .nav-link { padding: 4px 8px !important; font-size: 0.8rem; }
  .navbar-modern .navbar-brand { font-size: 0.9rem; }
  .navbar-modern .brand-text { display: none !important; }
  .guest-badge-fixed .badge { padding: 0.3rem 0.6rem !important; font-size: 0.65rem; }
  .nav-profile .user-name { display: none !important; }
  .avatar-thumb { width: 28px; height: 28px; }
}

/* Мобильные малые (<576px) - минимальная функциональность */
@media (max-width: 575px) {
  .navbar-modern .nav-link { padding: 3px 6px !important; font-size: 0.75rem; }
  .navbar-modern .navbar-brand { font-size: 0.85rem; }
  .navbar-modern .brand-text { display: none !important; }
  .guest-badge-fixed .badge { padding: 0.25rem 0.5rem !important; font-size: 0.6rem; }
  .nav-profile .user-name { display: none !important; }
  .avatar-thumb { width: 26px; height: 26px; }
  .nav-ellipsis-btn { padding: 3px 8px; font-size: 0.8rem; }
}

/* === АДАПТИВНЫЙ ДРОПДАУН ПРОФИЛЯ === */
.profile-dropdown-adaptive {
  min-width: 200px;
  transition: all 0.2s ease;
}

/* Адаптивное позиционирование дропдауна профиля */
@media (min-width: 768px) {
  .profile-dropdown-adaptive {
    right: 0 !important;
    left: auto !important;
    min-width: 220px;
  }
}

@media (min-width: 576px) and (max-width: 767px) {
  .profile-dropdown-adaptive {
    right: -5px !important;
    left: auto !important;
    min-width: 190px;
  }
}

@media (max-width: 575px) {
  .profile-dropdown-adaptive {
    right: -15px !important;
    left: auto !important;
    min-width: 170px;
    transform: translateX(0) !important;
  }
  
  .profile-dropdown-adaptive .dropdown-item {
    padding: 0.4rem 0.8rem;
    font-size: 0.85rem;
  }
}

@media (max-width: 400px) {
  .profile-dropdown-adaptive {
    right: -25px !important;
    min-width: 160px;
  }
  
  .profile-dropdown-adaptive .dropdown-item {
    padding: 0.35rem 0.7rem;
    font-size: 0.8rem;
  }
}

/* === УЛУЧШЕННЫЕ АНИМАЦИИ И ПЕРЕХОДЫ === */
.navbar-modern, .navbar-modern * {
  transition: all 0.3s ease;
}

.guest-badge-fixed .badge {
  transition: all 0.3s ease;
}

.nav-ellipsis-btn {
  transition: all 0.3s ease;
}
</style>

{% if request.session.is_guest %}
<style>
    .guest-badge .guest-tooltip {
        display: none;
        position: absolute;
        top: calc(100% + 10px);
        left: 50%;
        transform: translateX(-50%);
        width: clamp(240px, 55vw, 380px);
        background: rgba(15, 23, 42, 0.92);
        backdrop-filter: blur(26px);
        color: #e2e8f0;
        border-radius: 16px;
        border: 1px solid rgba(148, 163, 184, 0.4);
        box-shadow: 0 24px 60px rgba(15, 23, 42, 0.28);
        padding: 1.25rem 1.35rem;
        z-index: 2100;
        pointer-events: none;
        opacity: 0;
        transition: opacity .25s ease, transform .25s ease;
    }
    .guest-badge:hover .guest-tooltip {
        display: block;
        pointer-events: auto;
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    .guest-badge .guest-tooltip::before {
        content: '';
        position: absolute;
        top: -8px;
        left: 50%;
        transform: translateX(-50%);
        width: 14px;
        height: 14px;
        background: rgba(15, 23, 42, 0.92);
        border-left: 1px solid rgba(148,163,184,0.4);
        border-top: 1px solid rgba(148,163,184,0.4);
        transform: translateX(-50%) rotate(45deg);
        border-radius: 2px;
    }
    .guest-tooltip ul {
        padding-left: 1rem;
        margin-bottom: 0.5rem;
    }
    .guest-tooltip h6 {
        font-size: 0.95rem;
        color: #f8fafc;
        letter-spacing: 0.01em;
    }
    .guest-tooltip p,
    .guest-tooltip li {
        font-size: 0.86rem;
        line-height: 1.45;
        color: #cbd5f5;
    }
    .guest-tooltip__footer {
        border-top: 1px solid rgba(15, 23, 42, 0.08);
        padding-top: 0.75rem;
    }
</style>
{% endif %}
